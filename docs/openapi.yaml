openapi: 3.0.3
info:
  title: Transcendence API
  description: |
    API for the mighty Pong contest.
    Auth (42 OAuth), session, 2FA, and profile endpoints.
  version: 1.0.0
servers:
  - url: http://localhost:8000/api
    description: Local development server

components:
  securitySchemes:
    sessionAuth:
      type: apiKey
      in: cookie
      name: session

  schemas:
    User:
      type: object
      properties:
        id: { type: string, format: uuid, example: "123e4567-e89b-12d3-a456-426614174000" }
        username: { type: string, example: "great_ponger" }
        email: { type: string, format: email, example: "user@example.com" }
        avatar: { type: string, format: uri, nullable: true, example: "https://example.com/avatars/user1.png" }
        is2FAEnabled: { type: boolean, example: false }
        status: { type: string, enum: [ONLINE, OFFLINE, INGAME], example: ONLINE }
      required: [id, username, email, is2FAEnabled, status]

    Enable2FARequest:
      type: object
      properties:
        code: { type: string, example: "123456", description: TOTP code }
      required: [code]

    TwoFactorSecret:
      type: object
      properties:
        secret: { type: string, example: "JBSWY3DPEHPK3PXP" }
        qrCode: { type: string, example: "data:image/png;base64,..." }

    UpdateUserRequest:
      type: object
      properties:
        username: { type: string, example: "new_username" }
        avatar:
          type: string
          format: binary
          description: Image file to upload

security:
  - sessionAuth: []

paths:
  /auth/42/login:
    get:
      tags: [Auth]
      operationId: Auth_start42Login
      summary: Initiate 42 OAuth2 login
      responses:
        '302':
          description: Redirect to 42 authorization page.
          headers:
            Location:
              schema: { type: string }

  /auth/42/callback:
    get:
      tags: [Auth]
      operationId: Auth_handle42Callback
      summary: 42 OAuth2 callback
      parameters:
        - name: code
          in: query
          required: true
          schema: { type: string }
      responses:
        '302':
          description: Redirect to the frontend after creating a session.
          headers:
            Location:
              schema: { type: string }
        '401': { description: Invalid authorization code }

  /auth/status:
    get:
      tags: [Auth]
      operationId: Auth_getStatus
      summary: Get current authentication status
      responses:
        '200':
          description: Authenticated user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '401': { description: Not authenticated }

  /auth/logout:
    post:
      tags: [Auth]
      operationId: Auth_logout
      summary: Log out current user
      responses:
        '204': { description: Logged out }

  /auth/2fa/generate:
    post:
      tags: [TwoFA]
      operationId: Auth_generate2FA
      summary: Generate 2FA secret & QR
      responses:
        '200':
          description: Generated secret
          content:
            application/json:
              schema: { $ref: '#/components/schemas/TwoFactorSecret' }
        '401': { description: Not authenticated }

  /auth/2fa/enable:
    post:
      tags: [TwoFA]
      operationId: Auth_enable2FA
      summary: Enable 2FA
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Enable2FARequest' }
      responses:
        '200': { description: 2FA enabled }
        '400': { description: Invalid TOTP code }
        '401': { description: Not authenticated }

  /users/me:
    get:
      tags: [Users]
      operationId: Users_getMe
      summary: Get current user
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '401': { description: Not authenticated }

    patch:
      tags: [Users]
      operationId: Users_updateMe
      summary: Update current user
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema: { $ref: '#/components/schemas/UpdateUserRequest' }
      responses:
        '200':
          description: Updated user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '400': { description: Invalid input }
        '401': { description: Not authenticated }
