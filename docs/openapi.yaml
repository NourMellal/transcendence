openapi: 3.0.3
info:
  title: Transcendence API
  description: |
    API for the mighty Pong contest.
    Auth (42 OAuth), session, 2FA, and profile endpoints.
  version: 1.0.0
servers:
  - url: http://localhost:3000/api
    description: Local development server (API Gateway)

components:
  securitySchemes:
    sessionAuth:
      type: apiKey
      in: cookie
      name: session

  schemas:
    User:
      type: object
      properties:
        id: { type: string, format: uuid, example: "123e4567-e89b-12d3-a456-426614174000" }
        username: { type: string, example: "great_ponger" }
        email: { type: string, format: email, example: "user@example.com" }
        avatar: { type: string, format: uri, nullable: true, example: "https://example.com/avatars/user1.png" }
        is2FAEnabled: { type: boolean, example: false }
        status: { type: string, enum: [ONLINE, OFFLINE, INGAME], example: ONLINE }
      required: [id, username, email, is2FAEnabled, status]

    Enable2FARequest:
      type: object
      properties:
        code: { type: string, example: "123456", description: TOTP code }
      required: [code]

    TwoFactorSecret:
      type: object
      properties:
        secret: { type: string, example: "JBSWY3DPEHPK3PXP" }
        qrCode: { type: string, example: "data:image/png;base64,..." }

    UpdateUserRequest:
      type: object
      properties:
        username: { type: string, example: "new_username" }
        avatar:
          type: string
          format: binary
          description: Image file to upload

    # Game Schemas
    Game:
      type: object
      properties:
        id: { type: string, format: uuid, example: "game-123e4567" }
        player1: { type: string, format: uuid, example: "123e4567-e89b-12d3-a456-426614174000" }
        player2: { type: string, format: uuid, nullable: true, example: "123e4567-e89b-12d3-a456-426614174001" }
        status: { type: string, enum: [WAITING, PLAYING, FINISHED, CANCELLED], example: WAITING }
        score: 
          type: object
          properties:
            player1: { type: integer, example: 5 }
            player2: { type: integer, example: 3 }
        winner: { type: string, format: uuid, nullable: true, example: "123e4567-e89b-12d3-a456-426614174000" }
        createdAt: { type: string, format: date-time, example: "2025-10-22T10:00:00Z" }
        finishedAt: { type: string, format: date-time, nullable: true, example: "2025-10-22T10:15:00Z" }
      required: [id, player1, status, score, createdAt]

    CreateGameRequest:
      type: object
      properties:
        gameMode: { type: string, enum: [CLASSIC, TOURNAMENT], example: CLASSIC }
        isPrivate: { type: boolean, example: false }

    JoinGameRequest:
      type: object
      properties:
        gameId: { type: string, format: uuid, example: "game-123e4567" }

    GameMove:
      type: object
      properties:
        playerId: { type: string, format: uuid }
        direction: { type: string, enum: [UP, DOWN, STOP] }
        timestamp: { type: string, format: date-time }

    # Chat Schemas
    ChatMessage:
      type: object
      properties:
        id: { type: string, format: uuid, example: "msg-123e4567" }
        senderId: { type: string, format: uuid, example: "123e4567-e89b-12d3-a456-426614174000" }
        senderUsername: { type: string, example: "great_ponger" }
        content: { type: string, example: "Hello everyone!" }
        timestamp: { type: string, format: date-time, example: "2025-10-22T10:00:00Z" }
        type: { type: string, enum: [GLOBAL, PRIVATE, GAME], example: GLOBAL }
        recipientId: { type: string, format: uuid, nullable: true }
      required: [id, senderId, senderUsername, content, timestamp, type]

    SendMessageRequest:
      type: object
      properties:
        content: { type: string, example: "Hello everyone!", maxLength: 500 }
        type: { type: string, enum: [GLOBAL, PRIVATE, GAME], example: GLOBAL }
        recipientId: { type: string, format: uuid, nullable: true, example: "123e4567-e89b-12d3-a456-426614174001" }
      required: [content, type]

    # Tournament Schemas
    Tournament:
      type: object
      properties:
        id: { type: string, format: uuid, example: "tournament-123e4567" }
        name: { type: string, example: "Weekly Pong Championship" }
        description: { type: string, example: "The ultimate pong tournament!" }
        maxParticipants: { type: integer, example: 16, minimum: 4, maximum: 32 }
        currentParticipants: { type: integer, example: 8 }
        status: { type: string, enum: [REGISTRATION, ONGOING, FINISHED, CANCELLED], example: REGISTRATION }
        createdBy: { type: string, format: uuid, example: "123e4567-e89b-12d3-a456-426614174000" }
        participants: 
          type: array
          items: { $ref: '#/components/schemas/User' }
        bracket: 
          type: array
          items: { $ref: '#/components/schemas/TournamentMatch' }
        winner: { type: string, format: uuid, nullable: true }
        registrationDeadline: { type: string, format: date-time, example: "2025-10-25T18:00:00Z" }
        startDate: { type: string, format: date-time, example: "2025-10-26T10:00:00Z" }
        createdAt: { type: string, format: date-time, example: "2025-10-22T10:00:00Z" }
      required: [id, name, maxParticipants, currentParticipants, status, createdBy, participants, registrationDeadline, startDate, createdAt]

    TournamentMatch:
      type: object
      properties:
        id: { type: string, format: uuid, example: "match-123e4567" }
        tournamentId: { type: string, format: uuid, example: "tournament-123e4567" }
        player1: { type: string, format: uuid, nullable: true }
        player2: { type: string, format: uuid, nullable: true }
        winner: { type: string, format: uuid, nullable: true }
        round: { type: integer, example: 1 }
        matchNumber: { type: integer, example: 1 }
        status: { type: string, enum: [PENDING, PLAYING, FINISHED], example: PENDING }
        gameId: { type: string, format: uuid, nullable: true }
        scheduledAt: { type: string, format: date-time, nullable: true }
      required: [id, tournamentId, round, matchNumber, status]

    CreateTournamentRequest:
      type: object
      properties:
        name: { type: string, example: "Weekly Pong Championship", maxLength: 100 }
        description: { type: string, example: "The ultimate pong tournament!", maxLength: 500 }
        maxParticipants: { type: integer, example: 16, minimum: 4, maximum: 32 }
        registrationDeadline: { type: string, format: date-time, example: "2025-10-25T18:00:00Z" }
        startDate: { type: string, format: date-time, example: "2025-10-26T10:00:00Z" }
      required: [name, maxParticipants, registrationDeadline, startDate]

    # Stats Schemas
    UserStats:
      type: object
      properties:
        userId: { type: string, format: uuid }
        gamesPlayed: { type: integer, example: 25 }
        gamesWon: { type: integer, example: 18 }
        gamesLost: { type: integer, example: 7 }
        winRate: { type: number, format: float, example: 0.72 }
        tournamentsPlayed: { type: integer, example: 3 }
        tournamentsWon: { type: integer, example: 1 }
        ranking: { type: integer, example: 5 }
        totalScore: { type: integer, example: 1250 }
      required: [userId, gamesPlayed, gamesWon, gamesLost, winRate, tournamentsPlayed, tournamentsWon, ranking, totalScore]

    Leaderboard:
      type: object
      properties:
        topPlayers:
          type: array
          items: 
            type: object
            properties:
              user: { $ref: '#/components/schemas/User' }
              stats: { $ref: '#/components/schemas/UserStats' }
        lastUpdated: { type: string, format: date-time }

    # Error Schema
    Error:
      type: object
      properties:
        error: { type: string, example: "Invalid input" }
        message: { type: string, example: "The provided data is invalid" }
        code: { type: string, example: "INVALID_INPUT" }

security:
  - sessionAuth: []

paths:
  /auth/42/login:
    get:
      tags: [Auth]
      operationId: Auth_start42Login
      summary: Initiate 42 OAuth2 login
      responses:
        '302':
          description: Redirect to 42 authorization page.
          headers:
            Location:
              schema: { type: string }

  /auth/42/callback:
    get:
      tags: [Auth]
      operationId: Auth_handle42Callback
      summary: 42 OAuth2 callback
      parameters:
        - name: code
          in: query
          required: true
          schema: { type: string }
      responses:
        '302':
          description: Redirect to the frontend after creating a session.
          headers:
            Location:
              schema: { type: string }
        '401': { description: Invalid authorization code }

  /auth/status:
    get:
      tags: [Auth]
      operationId: Auth_getStatus
      summary: Get current authentication status
      responses:
        '200':
          description: Authenticated user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '401': { description: Not authenticated }

  /auth/logout:
    post:
      tags: [Auth]
      operationId: Auth_logout
      summary: Log out current user
      responses:
        '204': { description: Logged out }

  /auth/2fa/generate:
    post:
      tags: [TwoFA]
      operationId: Auth_generate2FA
      summary: Generate 2FA secret & QR
      responses:
        '200':
          description: Generated secret
          content:
            application/json:
              schema: { $ref: '#/components/schemas/TwoFactorSecret' }
        '401': { description: Not authenticated }

  /auth/2fa/enable:
    post:
      tags: [TwoFA]
      operationId: Auth_enable2FA
      summary: Enable 2FA
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Enable2FARequest' }
      responses:
        '200': { description: 2FA enabled }
        '400': { description: Invalid TOTP code }
        '401': { description: Not authenticated }

  /users/me:
    get:
      tags: [Users]
      operationId: Users_getMe
      summary: Get current user
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '401': { description: Not authenticated }

    patch:
      tags: [Users]
      operationId: Users_updateMe
      summary: Update current user
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema: { $ref: '#/components/schemas/UpdateUserRequest' }
      responses:
        '200':
          description: Updated user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '400': { description: Invalid input }
        '401': { description: Not authenticated }

  # Game Endpoints
  /games:
    get:
      tags: [Games]
      operationId: Games_listGames
      summary: List all games
      parameters:
        - name: status
          in: query
          schema: { type: string, enum: [WAITING, PLAYING, FINISHED, CANCELLED] }
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - name: offset
          in: query
          schema: { type: integer, minimum: 0, default: 0 }
      responses:
        '200':
          description: List of games
          content:
            application/json:
              schema:
                type: object
                properties:
                  games: { type: array, items: { $ref: '#/components/schemas/Game' } }
                  total: { type: integer }

    post:
      tags: [Games]
      operationId: Games_createGame
      summary: Create a new game
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateGameRequest' }
      responses:
        '201':
          description: Game created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Game' }
        '400': { description: Invalid input }
        '401': { description: Not authenticated }

  /games/{gameId}:
    get:
      tags: [Games]
      operationId: Games_getGame
      summary: Get game by ID
      parameters:
        - name: gameId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: Game details
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Game' }
        '404': { description: Game not found }

  /games/{gameId}/join:
    post:
      tags: [Games]
      operationId: Games_joinGame
      summary: Join an existing game
      parameters:
        - name: gameId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successfully joined game
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Game'
        '400':
          description: "Cannot join game (full, finished, etc.)"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
        '404':
          description: Game not found

  /games/{gameId}/leave:
    post:
      tags: [Games]
      operationId: Games_leaveGame
      summary: Leave a game
      parameters:
        - name: gameId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '204': { description: Successfully left game }
        '400': { description: Cannot leave game }
        '401': { description: Not authenticated }
        '404': { description: Game not found }

  /games/my-games:
    get:
      tags: [Games]
      operationId: Games_getMyGames
      summary: Get current user's games
      parameters:
        - name: status
          in: query
          schema: { type: string, enum: [WAITING, PLAYING, FINISHED, CANCELLED] }
      responses:
        '200':
          description: User's games
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Game' }
        '401': { description: Not authenticated }

  # Chat Endpoints
  /chat/messages:
    get:
      tags: [Chat]
      operationId: Chat_getMessages
      summary: Get chat messages
      parameters:
        - name: type
          in: query
          schema: { type: string, enum: [GLOBAL, PRIVATE, GAME], default: GLOBAL }
        - name: recipientId
          in: query
          schema: { type: string, format: uuid }
          description: Required for PRIVATE messages
        - name: gameId
          in: query
          schema: { type: string, format: uuid }
          description: Required for GAME messages
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, maximum: 100, default: 50 }
        - name: before
          in: query
          schema: { type: string, format: date-time }
          description: Get messages before this timestamp
      responses:
        '200':
          description: Chat messages
          content:
            application/json:
              schema:
                type: object
                properties:
                  messages: { type: array, items: { $ref: '#/components/schemas/ChatMessage' } }
                  hasMore: { type: boolean }
        '401': { description: Not authenticated }

    post:
      tags: [Chat]
      operationId: Chat_sendMessage
      summary: Send a chat message
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SendMessageRequest' }
      responses:
        '201':
          description: Message sent
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ChatMessage' }
        '400': { description: Invalid message content or recipient }
        '401': { description: Not authenticated }

  /chat/conversations:
    get:
      tags: [Chat]
      operationId: Chat_getConversations
      summary: Get user's private conversations
      responses:
        '200':
          description: List of conversations
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    recipientId: { type: string, format: uuid }
                    recipientUsername: { type: string }
                    lastMessage: { $ref: '#/components/schemas/ChatMessage' }
                    unreadCount: { type: integer }
        '401': { description: Not authenticated }

  # Tournament Endpoints
  /tournaments:
    get:
      tags: [Tournaments]
      operationId: Tournaments_listTournaments
      summary: List all tournaments
      parameters:
        - name: status
          in: query
          schema: { type: string, enum: [REGISTRATION, ONGOING, FINISHED, CANCELLED] }
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - name: offset
          in: query
          schema: { type: integer, minimum: 0, default: 0 }
      responses:
        '200':
          description: List of tournaments
          content:
            application/json:
              schema:
                type: object
                properties:
                  tournaments: { type: array, items: { $ref: '#/components/schemas/Tournament' } }
                  total: { type: integer }

    post:
      tags: [Tournaments]
      operationId: Tournaments_createTournament
      summary: Create a new tournament
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateTournamentRequest' }
      responses:
        '201':
          description: Tournament created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Tournament' }
        '400': { description: Invalid input }
        '401': { description: Not authenticated }

  /tournaments/{tournamentId}:
    get:
      tags: [Tournaments]
      operationId: Tournaments_getTournament
      summary: Get tournament by ID
      parameters:
        - name: tournamentId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: Tournament details
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Tournament' }
        '404': { description: Tournament not found }

  /tournaments/{tournamentId}/join:
    post:
      tags: [Tournaments]
      operationId: Tournaments_joinTournament
      summary: Join a tournament
      parameters:
        - name: tournamentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successfully joined tournament
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tournament'
        '400':
          description: "Cannot join tournament (full, started, etc.)"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
        '404':
          description: Tournament not found


  /tournaments/{tournamentId}/leave:
    post:
      tags: [Tournaments]
      operationId: Tournaments_leaveTournament
      summary: Leave a tournament
      parameters:
        - name: tournamentId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '204': { description: Successfully left tournament }
        '400': { description: Cannot leave tournament }
        '401': { description: Not authenticated }
        '404': { description: Tournament not found }

  /tournaments/{tournamentId}/bracket:
    get:
      tags: [Tournaments]
      operationId: Tournaments_getTournamentBracket
      summary: Get tournament bracket
      parameters:
        - name: tournamentId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: Tournament bracket
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/TournamentMatch' }
        '404': { description: Tournament not found }

  /tournaments/my-tournaments:
    get:
      tags: [Tournaments]
      operationId: Tournaments_getMyTournaments
      summary: Get current user's tournaments
      parameters:
        - name: status
          in: query
          schema: { type: string, enum: [REGISTRATION, ONGOING, FINISHED, CANCELLED] }
      responses:
        '200':
          description: User's tournaments
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Tournament' }
        '401': { description: Not authenticated }

  # Stats & Leaderboard Endpoints
  /stats/me:
    get:
      tags: [Stats]
      operationId: Stats_getMyStats
      summary: Get current user's statistics
      responses:
        '200':
          description: User statistics
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserStats' }
        '401': { description: Not authenticated }

  /stats/users/{userId}:
    get:
      tags: [Stats]
      operationId: Stats_getUserStats
      summary: Get user statistics by ID
      parameters:
        - name: userId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: User statistics
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserStats' }
        '404': { description: User not found }

  /leaderboard:
    get:
      tags: [Stats]
      operationId: Stats_getLeaderboard
      summary: Get global leaderboard
      parameters:
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, maximum: 100, default: 10 }
        - name: type
          in: query
          schema: { type: string, enum: [GAMES_WON, WIN_RATE, TOURNAMENTS_WON, TOTAL_SCORE], default: GAMES_WON }
      responses:
        '200':
          description: Leaderboard
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Leaderboard' }

  # Health Endpoints
  /health:
    get:
      tags: [System]
      operationId: System_health
      summary: API health check
      security: []
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string, example: "ok" }
                  timestamp: { type: string, format: date-time }
                  services:
                    type: object
                    properties:
                      userService: { type: string, enum: [healthy, unhealthy] }
                      gameService: { type: string, enum: [healthy, unhealthy] }
                      chatService: { type: string, enum: [healthy, unhealthy] }
                      tournamentService: { type: string, enum: [healthy, unhealthy] }
