# Docker Compose Configuration for Vault
# ======================================
# This file can be used standalone or integrated into main docker-compose.yml

version: '3.8'

services:
  vault:
    build:
      context: ../
      dockerfile: docker/Dockerfile
    container_name: transcendence-vault
    ports:
      - "8200:8200"  # Vault API
      - "8201:8201"  # Vault cluster port
    environment:
      # Development environment variables
      - VAULT_ADDR=http://0.0.0.0:8200
      - VAULT_API_ADDR=http://0.0.0.0:8200
      - VAULT_CLUSTER_ADDR=http://0.0.0.0:8201
      - VAULT_LOG_LEVEL=INFO
      # Skip TLS verification for development
      - VAULT_SKIP_VERIFY=true
    volumes:
      # Persistent data storage
      - vault-data:/vault/data
      - vault-logs:/vault/logs
      # Configuration override for different environments
      - ./config/vault-dev.hcl:/vault/config/vault.hcl:ro
    networks:
      - vault-network
    cap_add:
      # Required for Vault's memory protection features
      - IPC_LOCK
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/vault/health-check.sh"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s

  # Optional: Consul for production storage backend
  consul:
    image: consul:1.16
    container_name: transcendence-consul
    ports:
      - "8500:8500"
    environment:
      - CONSUL_BIND_INTERFACE=eth0
      - CONSUL_CLIENT_INTERFACE=eth0
    volumes:
      - consul-data:/consul/data
    networks:
      - vault-network
    command: |
      consul agent -dev -client=0.0.0.0 -ui
    profiles:
      - production
    restart: unless-stopped

  # Optional: Vault UI proxy for production
  vault-ui:
    image: nginx:alpine
    container_name: transcendence-vault-ui
    ports:
      - "8280:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - vault-network
    depends_on:
      - vault
    profiles:
      - ui
    restart: unless-stopped

volumes:
  vault-data:
    driver: local
  vault-logs:
    driver: local
  consul-data:
    driver: local

networks:
  vault-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16